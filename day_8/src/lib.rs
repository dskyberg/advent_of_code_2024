use std::collections::{HashMap, HashSet};

pub mod point;
pub use point::Point;

#[derive(Debug)]
pub struct Board {
    pub matrix: Vec<Vec<u8>>,
    pub map: HashMap<u8, Vec<Point>>,
}

impl Board {
    #[inline]
    pub fn valid_point(&self, p: &Point) -> bool {
        p.row >= 0
            && p.row < self.matrix.len() as isize
            && p.col >= 0
            && p.col < self.matrix[0].len() as isize
    }

    pub fn extend_map(&mut self, nodes: &HashSet<Point>) {
        for point in nodes {
            self.matrix[point.row as usize][point.col as usize] = b'#';
        }
    }
}

impl From<&str> for Board {
    fn from(input: &str) -> Self {
        let mut map = HashMap::new();
        let matrix = input
            .lines()
            .enumerate()
            .map(|(row, s)| {
                s.as_bytes()
                    .iter()
                    .enumerate()
                    .map(|(col, &b)| {
                        if b != b'.' {
                            map.entry(b).or_insert_with(Vec::new).push(Point {
                                row: row as isize,
                                col: col as isize,
                            });
                        }
                        b
                    })
                    .collect()
            })
            .collect();

        Self { matrix, map }
    }
}

impl std::fmt::Display for Board {
    fn fmt(&self, f: &mut std::fmt::Formatter<'_>) -> std::fmt::Result {
        for row in &self.matrix {
            for ant in row {
                write!(f, "{}", *ant as char)?;
            }
            writeln!(f)?;
        }
        writeln!(f)?;
        for (ant, locs) in &self.map {
            write!(f, "{}:", *ant as char)?;
            writeln!(
                f,
                "{}",
                locs.iter()
                    .map(|p| format!("{}", p))
                    .collect::<Vec<String>>()
                    .join(", ")
            )?;
        }
        Ok(())
    }
}
pub const TEST_DATA: &str = r#"T.........
...T......
.T........
..........
..........
..........
..........
..........
..........
.........."#;

pub const DATA: &str = r#"..........K........................A..............
.K................................A...............
......................................D.....A.....
....................................6............D
..................................................
.............................d....................
.........4.e.......................DT.B...........
....................d.....D......A...........B....
.............K....................................
...........................k......................
...w..............4.....................y.........
........w.........................................
..............g..k..............d..........y......
.....w.....Q..............................T.......
...............b..........k................6......
.................................W...T............
................w..............BW..T..............
............g....4e.....................W.........
.......1.................g.......................W
........k..........................6.....0........
.................a................................
....................4.a........3.g..............7.
.............m........................I.0.........
..............K7..............V...................
....Q................................I............
..9........b......................I...............
...................d..............................
.......e..........................................
....e...........t..E................3.............
......1..aQ........t....v.....3..........I..0.....
...........................v.t.....3.7............
..........i.......m........M......................
...Q..29..a...................m...................
...9......q..........mt...........................
....1...............Y.....M.........7.............
..........b..1...E.v..Y...........................
................v..........q...............0......
..................E.................5.............
9...i..2b................................8........
.....q..2............Y..M.........................
............q...............................V.....
...i.................................V............
.i..............E............M....................
.........................................G........
............8................Y....................
.........2................8..............5........
......................................5....V......
............................................G.....
.....................................5...........G
.................................8................"#;
